<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Galaxy Dream — Classroom Calming Visualizer</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #04021a;
    --bg-2: #0b1233;
    --accent: #7ae3f0;
    --accent2: #b58cff;
    --muted: rgba(255,255,255,0.08);
    --card: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Nunito,system-ui,Segoe UI,Roboto,-apple-system,Arial;}
  body{
    background: radial-gradient(1200px 600px at 20% 10%, rgba(115,22,255,0.14), transparent 6%),
                radial-gradient(900px 400px at 85% 80%, rgba(50,200,255,0.06), transparent 8%),
                linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color: #e6f7ff;
    display:flex;flex-direction:column;height:100vh;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }

  /* Top controls */
  #controls{
    display:flex;gap:14px;align-items:center;padding:14px 18px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    backdrop-filter: blur(8px); border-bottom: 1px solid rgba(255,255,255,0.02);
  }
  .brand{
    display:flex;align-items:center;gap:12px;margin-right:6px;
  }
  .logo {
    width:46px;height:46px;border-radius:12px;
    background: radial-gradient(circle at 30% 30%, #ffffff22, transparent 30%), linear-gradient(180deg,#8f6bff,#3fe6f0);
    display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.6);
  }
  .logo .dot { width:8px;height:8px;border-radius:50%;background:white;opacity:0.9;box-shadow:0 6px 14px rgba(120,0,255,0.25); }

  h1{font-size:18px;margin:0;font-weight:700;letter-spacing:0.2px;color:#eaf9ff;}
  .muted{font-size:12px;color:#b5eaf0;opacity:0.9}

  /* control items */
  .control {display:flex;flex-direction:column;gap:6px;font-size:13px;color:#cfeef7}
  input[type="range"]{width:140px;accent-color:#7ae3f0}
  select,input[type="color"]{padding:6px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:inherit}
  .grow{flex:1}

  /* visual area */
  #visual-wrap{position:relative;flex:1;overflow:hidden;border-top:1px solid rgba(255,255,255,0.02)}
  canvas{display:block;width:100%;height:100%;}

  /* overlay for loud */
  #overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .32s ease,transform .28s ease;}
  #overlay.show{opacity:1;pointer-events:auto}
  .overlay-card{
    background:linear-gradient(180deg, rgba(10,8,40,0.98), rgba(22,8,44,0.98));
    border:1px solid rgba(255,255,255,0.06);
    padding:28px 36px;border-radius:16px;box-shadow:0 20px 60px rgba(2,6,20,0.6);
    text-align:center;
  }
  .overlay-card h2{margin:0;font-size:56px;color:#ffccd5;letter-spacing:2px;text-shadow:0 8px 30px rgba(255,90,120,0.08);}
  .overlay-card p{margin-top:8px;color:#ffdfe7;font-size:18px}

  /* mascot moon */
  #mascot {
    position:absolute; right:22px; bottom:22px; width:132px; height:132px; pointer-events:none; opacity:0.96;
    filter: drop-shadow(0 14px 32px rgba(5,10,30,0.6));
  }

  /* footer tip */
  .footer-tip{position:absolute;left:20px;top:18px;font-size:12px;color:#a9eaf2;opacity:0.9}

  @media (max-width:820px){ .control {font-size:12px} .logo{width:40px;height:40px} .overlay-card h2{font-size:32px} }
</style>
</head>
<body>
  <div id="controls">
    <div class="brand">
      <div class="logo" aria-hidden="true"><div class="dot"></div></div>
      <div>
        <h1>Galaxy Dream</h1>
        <div class="muted">Calm visualizer for classrooms</div>
      </div>
    </div>

    <div class="control">
      <label>Bands</label>
      <input id="freqRange" type="range" min="8" max="128" value="64">
    </div>

    <div class="control">
      <label>Color</label>
      <input id="colorPicker" type="color" value="#7ae3f0">
    </div>

    <div class="control">
      <label>Shape</label>
      <select id="shapeSelect">
        <option value="bars">Starburst</option>
        <option value="circles">Orbs</option>
        <option value="dots">Fireflies</option>
      </select>
    </div>

    <div class="control">
      <label>Calm Mode</label>
      <input id="calmMode" type="checkbox">
    </div>

    <div class="control">
      <label>Music</label>
      <input id="musicToggle" type="checkbox">
    </div>

    <div class="control">
      <label>Music Vol</label>
      <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.32">
    </div>

    <div class="control">
      <label>Threshold</label>
      <input id="threshold" type="range" min="20" max="200" value="120">
      <div class="muted" id="thresholdVal">120</div>
    </div>

    <div class="grow"></div>

    <div class="muted footer-tip">Click anywhere to enable audio & mic</div>
  </div>

  <div id="visual-wrap">
    <canvas id="visualizer" aria-hidden="true"></canvas>

    <!-- overlay gently -->
    <div id="overlay" aria-hidden="true">
      <div class="overlay-card">
        <h2>Shh… Quiet Time</h2>
        <p>Let's use our indoor voices and breathe together ✨</p>
      </div>
    </div>

    <!-- Moon mascot -->
    <svg id="mascot" viewBox="0 0 200 200" aria-hidden="true">
      <defs>
        <radialGradient id="mg2" cx="30%" cy="30%">
          <stop offset="0" stop-color="#ffffff" stop-opacity="0.9"/>
          <stop offset="1" stop-color="#c4eefd" stop-opacity="0.06"/>
        </radialGradient>
      </defs>
      <circle cx="90" cy="90" r="68" fill="url(#mg2)"/>
      <g transform="translate(38,48)">
        <circle cx="5" cy="18" r="4" fill="#8ae7f3" opacity="0.9"/>
        <circle cx="48" cy="18" r="2.8" fill="#7ad6ff" opacity="0.95"/>
        <path d="M10 48c12 12 34 12 46 0" stroke="#6fbfd3" stroke-width="3" stroke-linecap="round" fill="none"/>
      </g>
    </svg>
  </div>

  <!-- background music element (royalty-free) -->
  <audio id="bgMusic" preload="auto" crossorigin="anonymous"
         src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_7f2c4a9b78.mp3?filename=calm-meditation-ambient-110397.mp3"></audio>

<script>
/* ----------------- DOM ----------------- */
const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d', { alpha: true });
const freqRange = document.getElementById('freqRange');
const colorPicker = document.getElementById('colorPicker');
const shapeSelect = document.getElementById('shapeSelect');
const calmMode = document.getElementById('calmMode');
const threshold = document.getElementById('threshold');
const thresholdVal = document.getElementById('thresholdVal');
const overlay = document.getElementById('overlay');
const musicToggle = document.getElementById('musicToggle');
const musicVol = document.getElementById('musicVol');
const bgMusic = document.getElementById('bgMusic');

/* ------------- Canvas sizing ------------- */
function resize(){
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * dpr;
  canvas.height = canvas.clientHeight * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', resize);
resize();

/* ------------- Audio / visual globals ------------- */
let audioCtx = null;
let analyser = null;
let dataArray = null;
let bufferLength = 0;
let prevData = null;
let flow = 0;
let alarmActive = false;
let alarmTimeout = null;

/* music nodes */
let musicSource = null;
let musicGain = null;
let audioUnlocked = false;

/* UI sync */
threshold.addEventListener('input', () => thresholdVal.textContent = threshold.value);

/* ---------- Audio initialization ---------- */
async function startAudio(){
  if (audioCtx) return;
  try {
    // create audio context
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // microphone
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    const micSrc = audioCtx.createMediaStreamSource(stream);
    micSrc.connect(analyser);

    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    prevData = new Uint8Array(bufferLength);

    // music nodes will be created when needed (connectMusicNodes)
  } catch (e) {
    console.warn("microphone unavailable:", e);
  }
}

/* ---------- Music node creation (create once) ---------- */
function connectMusicNodes(){
  if (!audioCtx) return;
  if (musicSource) return; // already connected

  try {
    musicSource = audioCtx.createMediaElementSource(bgMusic);
    musicGain = audioCtx.createGain();
    musicGain.gain.value = Number(musicVol.value) || 0.32;
    musicSource.connect(musicGain).connect(audioCtx.destination);
  } catch (e) {
    // some browsers disallow re-creating MediaElementSource — handle gracefully
    console.warn("music connect error:", e);
  }
}

/* ---------- Unlock audio on first gesture ---------- */
window.addEventListener('click', async function unlockOnce(){
  if (!audioCtx) await startAudio();
  if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();

  // attempt to play music (will be paused if toggle off)
  if (!audioUnlocked) {
    try { await bgMusic.play(); bgMusic.pause(); } catch(e){ /* autoplay blocked until toggle - ok */ }
    audioUnlocked = true;
  }
  // start main loop
  requestAnimationFrame(loop);
  window.removeEventListener('click', unlockOnce);
});

/* ---------- Music toggle & volume ---------- */
musicToggle.addEventListener('change', async (e) => {
  if (!audioCtx) await startAudio();
  if (!audioUnlocked) return; // must click first
  connectMusicNodes();
  if (e.target.checked){
    try { await bgMusic.play(); } catch(e){ console.warn('play blocked', e); }
  } else {
    bgMusic.pause();
  }
});
musicVol.addEventListener('input', () => {
  if (musicGain) musicGain.gain.setTargetAtTime(Number(musicVol.value), audioCtx.currentTime, 0.01);
  bgMusic.volume = Number(musicVol.value);
});

/* ---------- alarm sound ---------- */
function playAlarm(){
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine'; o.frequency.value = 440;
  g.gain.setValueAtTime(0.001, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.22, audioCtx.currentTime + 0.02);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + 0.9);
}

/* ---------- helpers ---------- */
function avg(arr){
  if(!arr || arr.length===0) return 0;
  let s=0; for(let i=0;i<arr.length;i++) s+=arr[i]; return s/arr.length;
}

/* ---------- visual helpers (galaxy) ---------- */
function drawStars(width,height,t){
  // subtle twinkling star field - deterministic per frame
  const count = 80;
  ctx.save();
  for(let i=0;i<count;i++){
    const px = (Math.sin(i*12.7 + t*0.0005)*0.5 + 0.5)*width;
    const py = (Math.cos(i*7.9 + t*0.0007)*0.5 + 0.5)*height;
    const r = (Math.abs(Math.sin(i+t*0.0003)) * 1.6) + 0.4;
    ctx.beginPath();
    ctx.fillStyle = `rgba(255,255,255,${0.04 + (Math.abs(Math.sin(t*0.0007+i))*0.06)})`;
    ctx.arc(px,py,r,0,Math.PI*2);
    ctx.fill();
  }
  ctx.restore();
}

function drawRibbons(width,height,t){
  // flowing nebula ribbons
  ctx.save();
  for(let layer=0; layer<3; layer++){
    ctx.beginPath();
    const hue = 230 - layer*18;
    const alpha = 0.045 + layer*0.02;
    ctx.fillStyle = `hsla(${hue},90%,60%,${alpha})`;
    const amp = 30 + layer*18;
    ctx.moveTo(0, height*0.2 + Math.sin(t*0.001 + layer)*amp);
    for(let x=0;x<=width;x+=width/24){
      const y = height* (0.25 + layer*0.08) + Math.sin((x*0.02)+t*0.0008 + layer)*amp;
      ctx.lineTo(x,y);
    }
    ctx.lineTo(width, height*1.2);
    ctx.lineTo(0, height*1.2);
    ctx.closePath();
    ctx.fill();
  }
  ctx.restore();
}

/* ---------- main visualizer ---------- */
function drawVisualizerFrame(){
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;
  const dpr = window.devicePixelRatio || 1;
  // clear
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // draw galaxy background elements
  const t = Date.now();
  drawRibbons(width,height,t);
  drawStars(width,height,t);

  // compute geometry
  const bars = Math.max(8, Math.min(256, Number(freqRange.value)));
  const centerX = width/2;
  const centerY = height/2.2;
  const baseR = Math.min(width, height)*0.22;

  flow += 0.002 + (calmMode.checked ? 0.0006 : 0);

  const slice = Math.max(1, Math.floor(bufferLength / bars));
  const color = colorPicker.value;

  // glow effect: draw halos
  for(let g=0; g<3; g++){
    ctx.beginPath();
    ctx.fillStyle = hexToRgba(color, 0.06 * (1.2 - g*0.3));
    ctx.arc(centerX, centerY, baseR + g*30 + Math.sin(flow*0.6)*6, 0, Math.PI*2);
    ctx.fill();
  }

  // draw bands/orbs
  ctx.lineWidth = 1.6;
  ctx.strokeStyle = color;
  ctx.fillStyle = color;

  for(let i=0;i<bars;i++){
    const idx = Math.min(bufferLength-1, i*slice);
    const raw = (dataArray[idx] || 0) / 255;
    const v = calmMode.checked ? (raw*0.6 + prevData[idx]/255*0.4) : raw;
    const mag = v * 120;
    const angle = (i/bars) * Math.PI*2;

    const wobble = Math.sin(angle*2.8 + flow*1.6) * 6 * v;
    const dist = baseR + Math.sin(flow*0.8 + i*0.02)*8 + mag*0.55 + wobble;

    const x = centerX + Math.cos(angle + flow*0.5) * dist;
    const y = centerY + Math.sin(angle + flow*0.5) * dist;

    if (shapeSelect.value === 'bars'){
      const x0 = centerX + Math.cos(angle) * baseR;
      const y0 = centerY + Math.sin(angle) * baseR;
      ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x,y); ctx.stroke();
      ctx.beginPath(); ctx.arc(x,y,3 + v*8,0,Math.PI*2); ctx.fill();
    } else if (shapeSelect.value === 'circles'){
      ctx.beginPath(); ctx.globalAlpha = 0.95; ctx.arc(x,y,6 + v*26,0,Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
    } else {
      ctx.beginPath(); ctx.arc(x,y,2 + v*12,0,Math.PI*2); ctx.fill();
    }
  }

  // soft particles
  for(let p=0;p<24;p++){
    const px = (Math.sin(p*6.7 + flow) * 0.45 + 0.5) * width;
    const py = (Math.cos(p*3.9 + flow*0.8) * 0.3 + 0.5) * height;
    ctx.beginPath(); ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.arc(px,py,4,0,Math.PI*2); ctx.fill();
  }
}

/* ---------- fallback placeholder ---------- */
function drawPlaceholder(){
  const w = canvas.clientWidth, h = canvas.clientHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'rgba(255,255,255,0.04)';
  for(let i=0;i<6;i++){
    ctx.beginPath(); ctx.arc(w*0.12 + i*(w*0.14), h*0.6, 18 + (i*6) * Math.abs(Math.sin(Date.now()/1400 + i)), 0, Math.PI*2);
    ctx.fill();
  }
  ctx.fillStyle = 'rgba(255,255,255,0.8)';
  ctx.font = '16px Nunito, Arial';
  ctx.fillText('Click anywhere to enable microphone and calming music', 20, 40);
}

/* ---------- main loop ---------- */
function loop(){
  if (!analyser || !dataArray) {
    drawPlaceholder();
    requestAnimationFrame(loop);
    return;
  }
  analyser.getByteFrequencyData(dataArray);

  // gentle smoothing if calm mode
  if (calmMode.checked){
    for(let i=0;i<dataArray.length;i++){
      dataArray[i] = Math.round(dataArray[i]*0.36 + prevData[i]*0.64);
    }
  }
  prevData.set(dataArray);

  const volume = avg(dataArray);
  const th = Number(threshold.value);

  if (volume > th && !alarmActive){
    alarmActive = true;
    overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
    playAlarm();
    // duck music
    if (musicGain && audioCtx) {
      musicGain.gain.cancelScheduledValues(audioCtx.currentTime);
      musicGain.gain.linearRampToValueAtTime(0.02, audioCtx.currentTime + 0.12);
    }
    clearTimeout(alarmTimeout);
    alarmTimeout = setTimeout(()=>{
      alarmActive = false; overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
      if (musicGain && audioCtx) musicGain.gain.linearRampToValueAtTime(Number(musicVol.value), audioCtx.currentTime + 0.6);
    }, 3000);
  }

  if (!alarmActive) drawVisualizerFrame();
  requestAnimationFrame(loop);
}

/* ---------- connect & control music safely ---------- */
function connectMusicOnce(){
  if (!audioCtx) return;
  if (musicSource) return;
  try{
    musicSource = audioCtx.createMediaElementSource(bgMusic);
    musicGain = audioCtx.createGain();
    musicGain.gain.value = Number(musicVol.value) || 0.32;
    musicSource.connect(musicGain).connect(audioCtx.destination);
  }catch(e){
    console.warn('music connect failed', e);
  }
}

/* music toggle */
musicToggle.addEventListener('change', async (ev) => {
  if (!audioCtx) await startAudio();
  if (!audioUnlocked) return; // must click to unlock
  connectMusicOnce();
  if (ev.target.checked){
    try{ await bgMusic.play(); }catch(e){ console.warn('bg play blocked', e);}
  } else bgMusic.pause();
});

/* volume control */
musicVol.addEventListener('input', () => {
  if (musicGain && audioCtx) musicGain.gain.setTargetAtTime(Number(musicVol.value), audioCtx.currentTime, 0.01);
  bgMusic.volume = Number(musicVol.value);
});

/* ---------- start audio on click (unlock rule) ---------- */
window.addEventListener('click', async function unlock(){
  if (!audioCtx) await startAudio();
  if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();
  // try start & pause to unlock element
  if (!audioUnlocked){
    try{ await bgMusic.play(); bgMusic.pause(); }catch(e){}
    audioUnlocked = true;
  }
  requestAnimationFrame(loop);
  window.removeEventListener('click', unlock);
});

/* ---------- audio start function ---------- */
async function startAudio(){
  if (audioCtx) return;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    analyser = audioCtx.createAnalyser(); analyser.fftSize = 1024;
    const mic = audioCtx.createMediaStreamSource(stream); mic.connect(analyser);
    bufferLength = analyser.frequencyBinCount; dataArray = new Uint8Array(bufferLength); prevData = new Uint8Array(bufferLength);
    // don't auto-connect bgMusic here; wait until toggle or unlocked
    connectMusicOnce();
  }catch(e){
    console.warn('startAudio failed:', e);
  }
}

/* ---------- small util: hex to rgba ---------- */
function hexToRgba(hex, alpha=1){
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16);
  const g = parseInt(c.substring(2,4),16);
  const b = parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ---------- initialize UI values & run placeholder loop ---------- */
thresholdVal.textContent = threshold.value;
bgMusic.volume = Number(musicVol.value);
requestAnimationFrame(loop);

</script>
</body>
</html>
